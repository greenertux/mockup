<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>dc.js example - Untappd Data Visualization</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/dc.css">
    <link rel="stylesheet" type="text/css" href="css/leaflet.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <!-- <link rel="stylesheet" type="text/css" href="css/style.min.css"> -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <!-- <link rel="stylesheet" href="css/style.min.css" /> -->
</head>
<body>
<div class="container-fluid">
  <div class="row" id="control-row">
    <div class="col-xs-3 pie-chart">
      <!-- <div class="dc-chart" id="chart-ring-year"><h4>Supplier <small><a id="year">reset</a></small></h4></div>

      <div class="dc-chart" id="chart-ring-month"><h4>Modell <span>(select up to 3) </span><small><a id="month" href="#">reset</a></small></h4></div> -->
      <h3>Pick a phone (or several)</h3>
      <div  id="js_mobile_tree"><h4>Select <span>(select up to 3) </span><small><a id="month" href="#">reset</a></small></h4></div>

    </div>
    <div class="col-xs-6 pie-chart">
      <div id="highchart_container" ></div>
      <!-- <div id="test_container" style="min-width: 310px; height: 400px; margin: 0 auto"></div> -->
    </div>
    <div class="col-xs-3">
      <h4>Where was the phone "<i><span id="curr_phone_info_name"></span></i>" sold?</h4>
      <div id="map"></div>
      <hr>

      <div class="form-group">
        <label for="sel1">Phone information for:</label>
        <select class="form-control" id="campaign_phone_current">
          <!-- <option>Hua Ascend G620S</option>
          <option>HTC Desire 620</option>
          <option>MS Lumia 535</option> -->
        </select>
      </div>
      <hr>
      <!--
      <h4>Forecast details</h4> -->
        <!-- Options used to create forecasts:

        <table>
          <tr><td>Time series</td>  	<td>Month of data</td></tr>
          <tr><td>Measures</td>  	<td>Sum of record count</td></tr>
          <tr><td>Forecase forward</td>  	<td>6 months</td></tr> -->
        <!-- </table> -->

        <div class="alert alert-warning" style="display:none" id="show_end_of_life_div">
          <strong>Attention!</strong>
          <h5><u>Generation Upgrade</u></h5>
          There is generation upgrade information available for this phone.
          <button type="button" class="btn btn-primary btn-xs" id="show_end_of_life">Show</button><br>
          <h5><u>Start campaign</u></h5>
          You can <button type="button" class="btn btn-primary btn-xs" id="show_end_of_life_campaign">try</button> and run a marketing campain for the old phone.

        </div>

        <!-- <h4>Show campaign influence</h4> -->


    <div id="toppings">Available campaigns:<br>
        <label><input type="checkbox" name="Twitter" value="1.05" /> Twitter (+5%)</label>
        <label><input type="checkbox" name="B" value="1.10" /> B (+10%)</label>
        <label><input type="checkbox" name="C" value="1.20" /> C (+20%)</label>
        <!-- <label><input type="checkbox" name="sausage" value=".50" /> sausage</label> -->
        <!-- <label><input type="checkbox" name="pepperoni" value=".50" /> pepperoni</label> -->
    </div>
    </div>
  </div>

 <!-- TABLE -->
  <div class="row" id="second_row">
    <div class="col-xs-12">
      <table class="table table-bordered table-striped" id="data-table">
        <thead>
          <tr class="header">
            <!-- <th>Supplier</th>
            <th>Modell</th>
            <th>Alias</th>
            <th>FC_01/07/2015</th>
            <th>FC_01/08/2015</th>
            <th>FC_01/09/2015</th>
            <th>FC_01/10/2015</th> -->
          </tr>
        </thead>
      </table>

    </div>
  </div>
</div>







<!-- Javascripts for highchart -->

<script src="js/jquery-2.2.3.min.js"></script>

<!-- <script src="https://code.highcharts.com/highcharts.js"></script> -->
<script src="js/highstock.js"></script>

<script>
// some globally defined variables
var campaign_settings = {};
var current_phone_name;
var range_value = 0.05;
var visible_phones = {}; // keeps track of currently visible phones
var visible_campaigns = {};
var phone_highChart;


// define highchart object first

var fake_phone_array = "[2608, 2862, 3306, 3850, 2364, 3539, 1856, 2965, 2430, 2773, 3206, 2149, 3954, 2790, 3484, 3288, 3127, 1803, 3074, 2928, 2951, 2862, 2791, 2735]";
var fake_phone_range = "[[2920, 3228],[2782, 3074],[2803, 3099],[2719, 3005],[2651, 2931],[2598, 2872]]";

var cont = document.getElementById('highchart_container');
var highchart_object = {
        chart: {
            type: 'line',
            renderTo: cont,
            events: {
              load: function(event) {
                //When is chart ready?
                console.log(this); //this refers to the loaded chart.
                // jQuery(".highcharts-input-group").remove();
            }
        }
        },
        credits: {
            enabled: false
        },
        rangeSelector: {
                selected: 4,
                inputEnabled: false,
                buttonTheme: {
                  visibility: 'hidden'
                },
                labelStyle: {
                  visibility: 'hidden'
                }
            },
        title: {
          text: 'How many were sold / will be sold?'
        },
        tooltip: {
            crosshairs: true,
            shared: true,
            valueSuffix: ' pcs'
        },
        // legend: {
        //     align: 'right',
        //     verticalAlign: 'top',
        //     layout: 'vertical',
        //     x: 0,
        //     y: 100
        // },
        legend: {
            enabled: true,
            //layout: 'vertical',

           },
        // subtitle: {
        //     text: 'Source: WorldClimate.com'
        // },
        xAxis: {
            // categories: ['Jan14', 'Feb14', 'Mar14', 'Apr14', 'May14', 'Jun14', 'Jul14', 'Aug14', 'Sep14', 'Oct14', 'Nov14', 'Dec14',
                        // 'Jan15', 'Feb15', 'Mar15', 'Apr15', 'May15', 'Jun15', 'Jul15', 'Aug15', 'Sep15', 'Oct15', 'Nov15', 'Dec15'],
            type: 'datetime',
            plotBands: [{ // Light air
                from: Date.UTC(2014, 0),
                to: Date.UTC(2015, 5),
                color: 'rgba(0, 0, 0, 0)',
                label: {
                    text: 'Historical',
                    style: {
                        color: '#606060'
                    }
                }
            }, { // Light breeze
                from: Date.UTC(2015, 6),
                to: Date.UTC(2015, 12),
                color: 'rgba(68, 170, 213, 0.1)',
                label: {
                    text: 'Prediction',
                    style: {
                        color: '#31a354'
                    }
                }
            }]


        },
        yAxis: {
            title: {
                text: 'Items sold (in k)'
            }
        },
        plotOptions: {
            line: {
                // dataLabels: {
                //     enabled: true
                // },
                enableMouseTracking: true
            }
        },
        // dataLabels: {
        //         enabled: true,
        //         crop: false,
        //         overflow: 'none',
        //         rotation: 45
        //     },
        series: []
    };


// phone_highChart = new Highcharts.Chart(highchart_object);
// phone_highChart =  new Highcharts.Chart(
 // phone_highChart = new Highcharts.Chart(highchart_object);
 phone_highChart = new Highcharts.StockChart(highchart_object);



</script>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/leaflet.js"></script>
<script type="text/javascript" src="js/leaflet-color-markers.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>
<script type="text/javascript" src="js/melt.js"></script>

<!-- <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script> -->
<script src="js/bootstrap.min.js"></script>

<!-- <script type="text/javascript" src="js/jstree.min.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script> -->
<script src="js/jstree.min.js"></script>

 <!-- javascript for editable table -->
<script src="js/mindmup-editabletable.js"></script>
<script src="js/numeric-input-example.js"></script>


<script type="text/javascript">
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// define geocoordinates for cities
var city2loc = {};
  city2loc["Warsaw"] = {"lat": 52.217169,"lng":21.038920, "ratio":0.4,  "cheap_ratio":0.2};
  city2loc["Gdansk"] = {"lat": 54.349164,"lng":18.660929, "ratio":0.1,  "cheap_ratio":0.2};
  city2loc["Katowice"] = {"lat": 50.251901,"lng":19.025972, "ratio":0.1,  "cheap_ratio":0.2};
  city2loc["Szczecin"] = {"lat": 53.414741,"lng":14.562025, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["Wroclaw"] = {"lat": 51.124086,"lng":17.023453, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["Rzeszow"] = {"lat": 50.035974,"lng":22.016602, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["Zakopane"] = {"lat": 49.299359,"lng":19.946879, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["Bialystok"] = {"lat": 53.142493,"lng":23.189629, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["Olsztyn"] = {"lat": 53.794161,"lng":20.487337, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["Pozna≈Ñ"] = {"lat": 52.430119,"lng":16.925855, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["Bydgoszcz"] = {"lat": 53.175730,"lng":17.965198, "ratio":0.2,  "cheap_ratio":0.2};
  city2loc["≈Å√≥d≈∫"] = {"lat": 51.783265,"lng":19.461852, "ratio":0.2,  "cheap_ratio":0.2};

var phone_colors = {};


var cheap_phones = {};
  cheap_phones["HTC Desire 620"] = 1;
  cheap_phones["Hua Ascend G620S"] = 1;
  cheap_phones["MS Lumia 535"] = 1;




// define colors for campaigns
var campaign_colors = {};
  campaign_colors["Twitter"] = "#bfff00";
  campaign_colors["B"] = "#00ff00";
  campaign_colors["C"] = "#00ffbf";
  // campaign_colors["Email"] = "#00bfff";


var end_of_live_info = {};
  end_of_live_info["HTC Desire 620"] = {"date": Date.UTC(2015, 3, 1)};

var jstree_string = {};

/* instantiate and configure map */
var map = L.map('map');
var breweryMarkers = new L.FeatureGroup();
var accessToken = 'pk.eyJ1IjoiZmFic3RhIiwiYSI6ImNpbXJ4YWhyMTAwNHV2emx5YzF3aTJqMHkifQ._iIWqJTraZ8NkOHVxw0Wtg';
L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=' + accessToken, {
    attribution: '¬© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> ¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 16
}).addTo(map);


var colour = d3.scale.category10();
var phone_dictionary = new Array(), curr_city2loc = new Array();
d3.json('phones.json', function (error, data) {
  // var beerData = data.response.beers.items;
  var beerData = data;

  // var beerData = melt(data,["TMID","Supplier","Name","Alias","Level"],"time");

  var parseDate = d3.time.format("%m_%Y");

  var fullDateFormat = d3.time.format('%a, %d %b %Y %X %Z');
  var yearFormat = d3.time.format('%Y');
  var monthFormat = d3.time.format('%b');
  var dayOfWeekFormat = d3.time.format('%a');


  // normalize/parse data so dc can correctly sort & bin them
  // I like to think of each "d" as a row in a spreadsheet
  var phone_counter = 0;
  _.each(beerData, function(d) {
    d.count = +d.count;
    d.alias = d.Alias;
    // d.timestamp = parseDate.parse(d.time);
    d.supplier = d.Supplier;
    d.modell = d.Name;
    d.wtf = "tester";

    // build string for jstree
    if(! jstree_string.hasOwnProperty(d.supplier) ){
      if(d.supplier === "Huawei" || d.supplier === "HTC"){
        jstree_string[d.supplier] =  { "text" : d.supplier, state : { 'selected' : true, 'opened': true ,"checkbox_disabled" : true}, children: [d.modell] }
      }
      else{
        // if(typeof(x) != "undefined"){
          jstree_string[d.supplier] =  { "text" : d.supplier, state : { 'selected' : false,"checkbox_disabled" : true }, 'children': [d.modell] }
        // }
      }
    }
    else{
      var curr_element = jstree_string[d.supplier];
      if(curr_element.hasOwnProperty('children')){
        curr_element.children.push(d.modell);
      }
      // jstree_string[d.supplier][children] = children;
    }
    // historical dataCount
    var historical_data = [parseFloat(d.HI_01_2014),parseFloat(d.HI_02_2014),parseFloat(d.HI_03_2014),parseFloat(d.HI_04_2014),parseFloat(d.HI_05_2014),parseFloat(d.HI_06_2014),parseFloat(d.HI_07_2014),parseFloat(d.HI_08_2014)
      ,parseFloat(d.HI_09_2014),parseFloat(d.HI_10_2014),parseFloat(d.HI_11_2014),parseFloat(d.HI_12_2014),d.HI_01_2015,d.HI_02_2015,d.HI_03_2015,d.HI_04_2015,d.HI_05_2015,d.HI_06_2015];

    var historical_data_new =   [[Date.UTC(2014, 0), parseFloat(d.HI_01_2014)],
      [Date.UTC(2014, 1), parseFloat(d.HI_02_2014)],
      [Date.UTC(2014, 2), parseFloat(d.HI_03_2014)],
      [Date.UTC(2014, 3), parseFloat(d.HI_04_2014)],
      [Date.UTC(2014, 4), parseFloat(d.HI_05_2014)],
      [Date.UTC(2014, 5), parseFloat(d.HI_06_2014)],
      [Date.UTC(2014, 6), parseFloat(d.HI_07_2014)],
      [Date.UTC(2014, 7), parseFloat(d.HI_08_2014)],
      [Date.UTC(2014, 8), parseFloat(d.HI_09_2014)],
      [Date.UTC(2014, 9), parseFloat(d.HI_10_2014)],
      [Date.UTC(2014, 10), parseFloat(d.HI_11_2014)],
      [Date.UTC(2014, 11), parseFloat(d.HI_12_2014)],
      [Date.UTC(2015, 0), parseFloat(d.HI_01_2015)],
      [Date.UTC(2015, 1), parseFloat(d.HI_02_2015)],
      [Date.UTC(2015, 2), parseFloat(d.HI_03_2015)],
      [Date.UTC(2015, 3), parseFloat(d.HI_04_2015)],
      [Date.UTC(2015, 4), parseFloat(d.HI_05_2015)],
      [Date.UTC(2015, 5), parseFloat(d.HI_06_2015)]
    ]
    var predicted_data_new = [
      [Date.UTC(2015, 6), parseFloat(d.FC_01_07_2015)],
      [Date.UTC(2015, 7), parseFloat(d.FC_01_08_2015)],
      [Date.UTC(2015, 8), parseFloat(d.FC_01_09_2015)],
      [Date.UTC(2015, 9), parseFloat(d.FC_01_10_2015)],
      [Date.UTC(2015, 10), parseFloat(d.FC_01_11_2015)],
      [Date.UTC(2015, 11), parseFloat(d.FC_01_12_2015)]
    ];

    d.total_sold = historical_data.reduce((prev,curr) => prev+curr)

    // var predicted_data = [d.HI_01_2015,d.HI_02_2015,d.HI_03_2015,d.HI_04_2015,d.HI_05_2015,d.HI_06_2015];

    var predicted_data = [d.FC_01_07_2015,d.FC_01_08_2015,d.FC_01_09_2015,d.FC_01_10_2015,d.FC_01_11_2015,d.FC_01_12_2015]
    // get the ranges
    var predicted_ranges = add_ranges(predicted_data,range_value);


    // save all
    phone_dictionary[d.modell]  = {
                                  // "all":{"name":d.modell, "data" : historical_data.concat(predicted_data)},
                                  "all":{"name":d.modell, "data" : historical_data_new.concat(predicted_data_new)},
                                  "historical":{"name":d.modell, "data" : historical_data_new},
                                  "predicted" :{"name":d.modell, "data" : predicted_data_new},
                                  "predicted_ranges" :{"name":d.modell, "data" : predicted_ranges},
                                };
    // get loc-data right
    for (var key in city2loc) {
      var chosen_color = colour(phone_counter % 20);
      var value = city2loc[key];
      var curr_ratio = value.ratio;
      if(d.modell in cheap_phones){
        curr_ratio = value.cheap_ratio;
      }
      var circle_value = curr_ratio * d.total_sold;
       if(! curr_city2loc.hasOwnProperty(d.modell) ){
        //  if(circle_value > 1000) circle_value = 1000;
        curr_city2loc[d.modell] = {};
        // curr_city2loc[d.modell]["color"] = chosen_color;

        curr_city2loc[d.modell][key] = {"lat": value.lat, "lng": value.lng, "value": circle_value, "color": chosen_color};
       }
      //  var circle_value = value.ratio * d.total_sold;
      //  if(circle_value > 5000) circle_value = 5000;
      //  else{
        // curr_city2loc[d.modell]["color"] = chosen_color;
        phone_colors[d.modell] = chosen_color;
        curr_city2loc[d.modell][key] = {"lat": value.lat, "lng": value.lng, "value": circle_value, "color": chosen_color};
      //  }
    }
    var max_lat = 54, min_lat = 50, max_lng = 24,min_lng = 15;
    d.lat = Math.random() * (max_lat - min_lat) + min_lat;
    d.lng = Math.random() * (max_lng - min_lng) + min_lng;
    phone_counter++;
});


// ok, this is nasty, but we need to construct a json to feed to jstree
var test_string = {"core": {"data":[] },checkbox : {tie_selection : false },plugins : ['checkbox']};
var helper_string = { "text" : "Devices", "state" : { "opened" : true,"checkbox_disabled" : true }, children : [] };
for (var key in jstree_string) {
  var json_value = jstree_string[key];
  helper_string.children.push(json_value);
}
test_string.core.data.push(helper_string);

jQuery('#js_mobile_tree').jstree(test_string);


  // set crossfilter
  var ndx = crossfilter(beerData);
  // create dimensions (x-axis values)
  var yearDim  = ndx.dimension(function(d) {return d.first_had_year;}),
      // dc.pluck: short-hand for same kind of anon. function we used for yearDim
      xy_dim = ndx.dimension(function (d) {
              return [+d.x, +d.y];
          })
      supplierDim = ndx.dimension(dc.pluck('supplier')),
      modellDim = ndx.dimension(dc.pluck('modell')),
      monthDim  = ndx.dimension(dc.pluck('first_had_month')),
      dayOfWeekDim = ndx.dimension(dc.pluck('first_had_day')),
      ratingDim = ndx.dimension(dc.pluck('rating_score')),
      allDim = ndx.dimension(function(d) {return d;});

  // create groups (y-axis values)
  var all = ndx.groupAll();
  var countPerYear = yearDim.group().reduceCount(),
      countPerMonth = monthDim.group().reduceCount(),
      countPerDay = dayOfWeekDim.group().reduceCount(),
      countPerRating = ratingDim.group().reduceCount(),
      xy_group = xy_dim.group(),
      // countPerTime = timeDim.group().reduceCount(),
      countPerSupplier = supplierDim.group().reduceCount(),
      countPerModel = modellDim.group().reduceCount(),
      countPerSupplier_normalized       = supplierDim.group().reduceSum(function(d) {return 1;});



  // specify charts
  var yearChart   = dc.pieChart('#chart-ring-year'),
      monthChart   = dc.pieChart('#chart-ring-month'),
      scatterPlotChart = dc.scatterPlot("#chart-scatterplot"),
      dataCount = dc.dataCount('#data-count'),
      dataTable = dc.dataTable('#data-table'),
      seriesChart = dc.seriesChart("#chart-rating-count");

  yearChart
          .width(250)
          .height(250)
          .dimension(supplierDim)
          .group(countPerSupplier_normalized)
          .renderLabel(false)
          .renderTitle(false)
          .innerRadius(80)
          .legend(dc.legend().x(95).y(55).itemHeight(10).gap(1));


          monthChart
              .width(250)
              .height(250)
              .dimension(modellDim)
              .group(countPerModel)
              .renderLabel(false)
              .renderTitle(false)
              .innerRadius(125)
              // .legend(dc.legend().x(95).y(55).itemHeight(10).gap(1))
              .legend(dc.legend().x(30).y(0).itemHeight(10).gap(1).horizontal(1).legendWidth(90).itemWidth(95))


              dc.override(monthChart, 'legendables', function() {
                  var legendables = this._legendables();
                  return legendables.filter(function(l) {
                      return l.data > 0;
                  });
              });

// scatterplot
          scatterPlotChart.width(1200)
              .height(300)
              .x(d3.scale.linear().domain([0, 500]))
              .yAxisLabel("Forecast")
              .xAxisLabel("Historic")
              .clipPadding(10)
              .dimension(xy_dim)
              // .excludedOpacity(0.5)
              .group(xy_group);

  dataCount
      .dimension(ndx)
      .group(all);

   dataTable
    .dimension(allDim)
    .group(function (d) { return 'dc.js insists on putting a row here so I remove it using JS'; })
    .size(100)
    // .columns([
    //   function (d) { return d.supplier; },
    //   function (d) { return d.modell; },
    //   function (d) { return d.alias; },
    //   function (d) { return d.FC_01_07_2015; },
    //   function (d) { return d.FC_01_08_2015; },
    //   function (d) { return d.FC_01_09_2015; },
    //   function (d) { return d.FC_01_10_2015; }
    //
    // ])
    .sortBy(dc.pluck('supplier'))
    .order(d3.descending)
    .on('renderlet', function (table) {
      // // each time table is rendered remove nasty extra row dc.js insists on adding
      table.select('tr.dc-table-group').remove();
      //
      // // update map with breweries to match filtered data
      breweryMarkers.clearLayers();
      var marker_counter = 0;
      _.each(allDim.top(Infinity), function (d) {
        // var loc = d.brewery.location;
        var name = d.modell;
        for (var key in curr_city2loc[d.modell]) {
          var value = curr_city2loc[d.modell][key]
          // curr_city2loc[d.modell];
          // var circle_size =
          var marker  = L.circle([value.lat, value.lng], value.value * 2, {color:value.color, fillOpacity:1});
          marker.bindPopup("<p>" + name + " " + d.modell + " " + d.supplier + "</p>");
          // L.marker([51.5, -0.09], {icon: greenIcon}).addTo(map);

          breweryMarkers.addLayer(marker);
        }

          // var marker = L.marker([d.lat, d.lng]);

        // }
        marker_counter++;
      });
      map.addLayer(breweryMarkers);
      map.fitBounds(breweryMarkers.getBounds());
    });

  // register handlers
  // d3.selectAll('a#all').on('click', function () {
  //   dc.filterAll();
  //   dc.renderAll();
  //   phone_highChart = new Highcharts.Chart(highchart_object);
  // });

  d3.selectAll('a#year').on('click', function () {
    yearChart.filterAll();
    dc.redrawAll();
  });

  d3.selectAll('a#month').on('click', function () {
    monthChart.filterAll();

    dc.redrawAll();
  });


  monthChart.on('renderlet.barclicker', function(chart, filter){
    chart.selectAll('text').on('click', function(d) {
        // use the data in d to take the right action
        console.log("clicked on modell");
        //update highchart with data from d
        // d.name

        // get current data
        var new_phone_data = phone_dictionary[d.name]['all'];
        var curr_series = highchart_object.series;
        if(curr_series.length > 2){
          curr_series.shift();
        }
        curr_series.push(new_phone_data)
        highchart_object.series = curr_series;
        // highchart_object.series = [{name: 'A', data: [1,2,3,2,1]}];
        //  highchart_object.series = [test];
        // highchart_object.series = [];
        // phone_highChart.redraw();

        phone_highChart.addSeries({
                       name: d.name,
                       data: new_phone_data.data ,
                       color: phone_colors[d.modell],
                      //  pointStart: Date.UTC(2014, 0, 1),
                      //  pointInterval: 2629746000, // one month
                       marker: {
                       fillColor: curr_city2loc[d.name]["color"],
                       lineWidth: 2,
                       lineColor: curr_city2loc[d.name]["color"]
                       }
                   });

        // phone_highChart = new Highcharts.Chart(highchart_object);

    dc.redrawAll();
  });
});

  d3.selectAll('path#month').on('click', function () {
    console.log("clicked on modell");
  });

  d3.selectAll('a#day').on('click', function () {
    dayChart.filterAll();

    dc.redrawAll();
  });

  // showtime!
  dc.renderAll();

});

jQuery('#js_mobile_tree').on("select_node.jstree", function (e, data) {
  console.log("node_id: " + data.node.id);
});

jQuery("#js_mobile_tree").on("click", ".jstree-anchor", function(e) {

   var selected_node = jQuery("#js_mobile_tree").jstree(true).get_node(jQuery(this)).original;
   var id = jQuery("#js_mobile_tree").jstree(true).get_node($(this)).id;

   console.log(selected_node+" adding class to id: "+id);

   // filter on selected Devices
   // get data for selected phone
   var new_phone_data = phone_dictionary[selected_node]['all'] ;
   current_phone_name = selected_node;
   // get current series in highchart
   var curr_series = phone_highChart.series;

  var predicted_ranges = phone_dictionary[selected_node]['predicted_ranges'].data ;
   // does phone already exist?
   if(! visible_phones.hasOwnProperty(selected_node) ){
     phone_highChart.addSeries({
                  name: selected_node,
                  data: new_phone_data.data ,
                  zIndex: 1,
                  color: phone_colors[selected_node],
                  // pointStart: Date.UTC(2014, 0, 1),
                  // pointInterval: 2629746000, // one month
                  // pointInterval: 3600 * 1000 * 24 * 30// one hour
                  marker: {
                  fillColor: curr_city2loc[selected_node]["color"],
                  lineWidth: 2,
                  lineColor: curr_city2loc[selected_node]["color"]
                  }
              }
            );
              visible_phones[selected_node] = 1;
              jQuery("#"+id+"_anchor").addClass('jstree-checked');

              // activate option in select_node
              // mySelect.add(new Option('My option', 1, true));
              // $('campaign_phone_current').append('<option val="1">One</option>');
              $( "#campaign_phone_current" ).append("<option value='"+selected_node+"' selected>"+selected_node+"</option>")
              check_end_of_live_available(selected_node);
              // if(selected_node in campaign_settings){
              //   var curr_campaign_settings = campaign_settings[selected_node];
              //   console.log("setting labels with current configuration");
              // }
              // else{
                  campaign_settings[selected_node] = {"Twitter":0,"B":0,"C":0};
                  console.log("start with fresh configuration");
              // }
              // reset labels
              set_campaign_settings();
              // redraw_legend();
    }
    else{
      // remove phone
                for(var i = phone_highChart.series.length - 1; i > -1; i--)
                {
                    var curr_ele = curr_series[i];
                    var curr_ele_name = curr_ele.name;
                    // use regular expression here
                    var curr_series_name = phone_highChart.series[i].name;
                    var re = new RegExp("/\b"+selected_node+"\b/");
                    var re = new RegExp(selected_node);
                    console.log("checking line with name: "+curr_series_name);
                    if(curr_series_name.match(re)){
                      console.log("removing line for "+curr_series_name);
                      phone_highChart.series[i].remove();
                      delete visible_campaigns[curr_ele_name];
                    }
                }
                delete visible_phones[selected_node];
                // phone_highChart.redraw();
                check_end_of_live_available("dummy");
                jQuery("#"+id+"_anchor").removeClass('jstree-checked');
                $("#campaign_phone_current option[value='"+selected_node+"']").remove();
                set_campaign_settings();
                jQuery("#show_end_of_life_campaign").text("try");
                jQuery("#show_end_of_life").text("Show");
                // redraw_legend();
    }
    // update current phone Stats
    d3.selectAll("#curr_phone_info_name").text(selected_node);
        // don't filter out old phones
               modellDim.filter(selected_node);
              // dc.filterAll(selected_node);
              dc.redrawAll();
});


// get reference to element containing toppings checkboxes
var el = document.getElementById('toppings');

// get reference to input elements in toppings container element
var tops = el.getElementsByTagName('input');

// assign function to onclick property of each checkbox
for (var i=0, len=tops.length; i<len; i++) {
    if ( tops[i].type === 'checkbox' ) {
        tops[i].onclick = updateTotal;
    }
}

function updateTotal(e) {
    // 'this' is reference to checkbox clicked on
    var form = this.form;

    // get current value in total text box, using parseFloat since it is a string
    var val = this.name, factor = this.value;


    var current_phone_name = $( "#campaign_phone_current" ).val();
    var curr_label_name = current_phone_name+" ("+val+")";

    // if check box is checked, add its value to val, otherwise subtract it
    if ( this.checked ) {
        // val += parseFloat(this.value);

        // if(!(curr_label_name in visible_campaigns)){
          var predicted_data = phone_dictionary[current_phone_name]['predicted'].data;
          // add last real data item
          var historical_data = phone_dictionary[current_phone_name]['historical'].data
          var changed_array = adjust_array(predicted_data,factor);
          changed_array.unshift(historical_data[historical_data.length - 1])

          phone_highChart.addSeries({
                     name: curr_label_name,
                     data:  changed_array,
                    //  pointStart: Date.UTC(2015, 7, 1),
                    //  pointInterval: 2629746000, // one month
                     color: campaign_colors[val],
                    //  marker: {
                    //  fillColor: campaign_colors[val],
                    //  lineWidth: 1,
                    //  lineColor: campaign_colors[val]
                    //  }
                 });
                 campaign_settings[current_phone_name][val] = 1;
                 console.log("add campaign for "+this.value);
          // }
        // visible_campaigns[val] = 1;
        // update campaign configurations
        // campaign_settings[] = 1;
    } else {
        console.log("remove campaign for "+this.value);
        for(var i = phone_highChart.series.length - 1; i > -1; i--)
        {
            var curr_ele = phone_highChart.series[i];
            var curr_ele_name = curr_ele.name;
            //chart.series[i].remove();
            if(curr_ele_name == curr_label_name)
                // delete curr_series[i];
                phone_highChart.series[i].remove();
        }
        campaign_settings[current_phone_name][val] = 0;
    }

    // format val with correct number of decimal places
    // and use it to update value of total text box
    // form.elements['total'].value = formatDecimal(val);
}


d3.selectAll('a#campaign_list').on('click', function () {
  var predicted_data = phone_dictionary[current_phone_name]['predicted'].data ;
  // monthChart.filterAll();

  // dc.redrawAll();
});

function adjust_array(prediction_array, factor){
    // iterate over predicted Array
    var i, n = prediction_array.length, new_array = new Array;
    for (i = 0; i < n; ++i) {
        new_array[i] = [prediction_array[i][0],prediction_array[i][1] * factor];
      }
      return new_array;
}

function add_ranges(prediction_array, range_value){
    // iterate over predicted Array
    var i, n = prediction_array.length, new_array = new Array;
    for (i = 0; i < n; ++i) {
        new_array[i] =  [prediction_array[i] + (1- range_value), prediction_array[i] + (1+ range_value)];
      }
      return new_array;
}

//////////////////
// initialise stuff!
//////////////////
jQuery("#js_mobile_tree")
    .bind('ready.jstree', function(e, data) {
        // invoked after jstree has loaded
        jQuery("#j1_36_anchor").click();
        jQuery("#j1_36_anchor").addClass('jstree-checked');

        jQuery(".highcharts-input-group").remove();

     })


var button = document.getElementById("show_end_of_life");
     button.onclick = function(){

       // check which setting the button currently has


      //  alert("show end-of-life line now!");
      var curr_phone = "HTC Desire 620", curr_competitor = "Hua Ascend G620S";
      var old_pair_phones = {"HTC Desire 620":1,"Hua Ascend G620S":1};
      var historical_data_old = phone_dictionary[curr_phone]['historical'].data
      var historical_data_competitor = phone_dictionary[curr_competitor]['historical'].data

       // draw new line for old phone
       var old_data = [
          [Date.UTC(2015, 6), 2369],
          [Date.UTC(2015, 7), 1185],
          [Date.UTC(2015, 8), 0]]
       var successor_data = [
         [Date.UTC(2015, 6), 200],
         [Date.UTC(2015, 7), 600],
         [Date.UTC(2015, 8), 1403],
         [Date.UTC(2015, 9), 4398],
         [Date.UTC(2015, 10), 4838],
         [Date.UTC(2015, 11), 5418]];


       var competitor_data = [
         [Date.UTC(2015, 6),3419],
         [Date.UTC(2015, 7),4103],
         [Date.UTC(2015, 8),4144],
         [Date.UTC(2015, 9),2434],
         [Date.UTC(2015, 10),2190],
         [Date.UTC(2015, 11),1971]
       ];
       var old_label = "HTC Desire 620 (gen_upgrade)", successor_label = "HTC Desire 620 (successor)", competitor_label = "Hua Ascend G620S (gen_upgrade)";
      //  var old_color = "#8c7373", successor_color = "#996666", competitor_color = "#b34d4d";
      if(jQuery("#show_end_of_life").text() == "Show"){
        var color_old = phone_colors[curr_phone], color_successor = "#881b1b",color_competitor = phone_colors[curr_competitor];


       if(!(old_label in visible_campaigns)){

       // add the last historical value to phones
       old_data.unshift(historical_data_old[historical_data_old.length - 1])
       // add the last historical value to phones
       competitor_data.unshift(historical_data_competitor[historical_data_competitor.length - 1])


       phone_highChart.addSeries({
                    name: old_label,
                    data:  old_data,

                    // color: color_old,
                    color: color_old,

                    dashStyle: 'longdash',
                    id : 'outdated_phone_id'
                   //  marker: {
                   //  fillColor: campaign_colors[val],
                   //  lineWidth: 1,
                   //  lineColor: campaign_colors[val]
                   //  }
                },{
                    type : 'flags',
                    data : [{
                        x : Date.UTC(2015, 6),
                        title : 'End',
                        text : 'End of life for phone'
                    }],
                    onSeries : 'outdated_phone_id',
                    shape : 'circlepin',
                    // width : 16
                });
       // draw line for successor phone
       phone_highChart.addSeries({
                    name: successor_label,
                    data:  successor_data,
                    color: color_successor,
                    dashStyle: 'longdash',
                });

       // draw new line for competitor
       phone_highChart.addSeries({
                    name: competitor_label,
                    data:  competitor_data,
                    // pointStart: Date.UTC(2015, 5, 1),
                    // pointInterval: 2629746000, // one month
                    color: color_competitor,
                    dashStyle: 'longdash',
                   //  marker: {
                   //  fillColor: campaign_colors[val],
                   //  lineWidth: 1,
                   //  lineColor: campaign_colors[val]
                   //  }
                });
                visible_campaigns[old_label] = 1;
                visible_campaigns[successor_label] = 1;
                visible_campaigns[competitor_label] = 1;

                // now disable the original phones

                disable_series(old_pair_phones);

              }
              jQuery("#show_end_of_life").text("Hide");
            }
            else{
                var phones_to_delete = {};
                phones_to_delete[old_label] = 1,phones_to_delete[successor_label] = 1,phones_to_delete[competitor_label] = 1 ;
                delete_series(phones_to_delete);
                enable_series(old_pair_phones)
                delete visible_campaigns[old_label];
                delete visible_campaigns[successor_label];
                delete visible_campaigns[competitor_label];

                jQuery("#show_end_of_life").text("Show");
            }

     }

var button = document.getElementById("show_end_of_life_campaign");
          button.onclick = function(){
            //do stuff
           //  alert("show end-of-life line now!");
           var curr_phone = "HTC Desire 620", curr_competitor = "Hua Ascend G620S";

           var historical_data_old = phone_dictionary[curr_phone]['historical'].data
           var historical_data_competitor = phone_dictionary[curr_competitor]['historical'].data

           var color_old = phone_colors[curr_phone], color_competitor = phone_colors[curr_competitor];
            // draw new line for old phone
            var old_data = [
              [Date.UTC(2015, 6),4343],
              [Date.UTC(2015, 7),4387],
              [Date.UTC(2015, 8),2193],
              [Date.UTC(2015, 9),100]
            ]
            var competitor_data = [
              [Date.UTC(2015, 6),3077],
              [Date.UTC(2015, 7),3283],
              [Date.UTC(2015, 8),3315],
              [Date.UTC(2015, 9),2704],
              [Date.UTC(2015, 10),2771],
              [Date.UTC(2015, 11),2839]
            ];
            var old_label = "HTC Desire 620 (campaign)", competitor_label = "Hua Ascend G620S (campaign)";
            // var old_color = "#58D3F7",  competitor_color = "#088A85";

            var test_button = jQuery("#show_end_of_life_campaign").text();
            if(jQuery("#show_end_of_life_campaign").text() == "try"){

            if(!(old_label in visible_campaigns)){
              // add the last historical value to phones
              old_data.unshift(historical_data_old[historical_data_old.length - 1])
              // add the last historical value to phones
              competitor_data.unshift(historical_data_competitor[historical_data_competitor.length - 1])

            phone_highChart.addSeries({
                         name: old_label,
                         data:  old_data,
                         pointStart: Date.UTC(2015, 5, 1),
                         pointInterval: 2629746000, // one month
                         color: color_old,
                         dashStyle: 'shortdot'
                        //  marker: {
                        //  fillColor: campaign_colors[val],
                        //  lineWidth: 1,
                        //  lineColor: campaign_colors[val]
                        //  }
                     });
                     visible_campaigns[old_label] = 1;
            // draw new line for competitor
            phone_highChart.addSeries({
                         name: competitor_label,
                         data:  competitor_data,
                         pointStart: Date.UTC(2015, 5, 1),
                         pointInterval: 2629746000, // one month
                         color: color_competitor,
                         dashStyle: 'shortdot'
                        //  marker: {
                        //  fillColor: campaign_colors[val],
                        //  lineWidth: 1,
                        //  lineColor: campaign_colors[val]
                        //  }
                     });
                     visible_campaigns[competitor_label] = 1;

                   }
                   jQuery("#show_end_of_life_campaign").text("hide");
              }
              else{


                var phones_to_delete = {};
                phones_to_delete[old_label] = 1, phones_to_delete[competitor_label] = 1 ;
                delete_series(phones_to_delete);
                // enable_series(old_pair_phones)
                delete visible_campaigns[old_label];
                // delete visible_campaigns[successor_label];
                delete visible_campaigns[competitor_label];

                jQuery("#show_end_of_life_campaign").text("try");

              }

          }


// $('#mainTable').editableTableWidget();
// .numericInputExample().find('td:first').focus();

$( "#campaign_phone_current" ).change(function() {
  // alert( "Handler for .change() called." );
  // ok, load configuration for labels
  var curr_phone_name = $( "#campaign_phone_current" ).val();
  // var curr_settings = campaign_settings[curr_phone_name];
  set_campaign_settings(curr_phone_name);

  modellDim.filter(curr_phone_name);
 // dc.filterAll(selected_node);
  dc.redrawAll();

});


function disable_series(phones){
    $(phone_highChart.series).each(function(){
                //this.hide();
                if(this.name in phones){
                    this.setVisible(false, false);
                  }
    });
  phone_highChart.redraw();
}

function enable_series(phones){
    $(phone_highChart.series).each(function(){
                //this.hide();
                if(this.name in phones){
                    this.setVisible(true, false);
                  }
    });
  phone_highChart.redraw();
}


function delete_series(phones){
    $(phone_highChart.series).each(function(){
                //this.hide();
                if(this.name in phones){
                    this.remove();
                }
    });
  phone_highChart.redraw();
}



function set_campaign_settings(modell){
  // get safed vaues
  if(modell === undefined) {
        //no modell given.
        // means we just reset all input labels
        for(var d in campaign_colors) {
          console.log("resetting "+d);
              $( "input[name='"+d+"']" ).prop( "checked", false )
        }
  }

  var curr_settings = campaign_settings[modell];
  for(var d in curr_settings) {
    var curr_val = curr_settings[d];
    console.log("setting "+d);
    if(curr_val == 1){
        $( "input[name='"+d+"']" ).prop( "checked", true )
    }
    else{
      $( "input[name='"+d+"']" ).prop( "checked", false )
    }
  }
}


function check_end_of_live_available(modell){
  if(modell in end_of_live_info)
    jQuery("#show_end_of_life_div").show();
  else
    jQuery("#show_end_of_life_div").hide();
}


function redraw_legend(){
  for(i in phone_highChart.series){
            phone_highChart.series[i].update({ showInLegend: false }, false);
  }
  phone_highChart.redraw();

  for(i in phone_highChart.series){
            phone_highChart.series[i].update({ showInLegend: true }, false);
  }
  phone_highChart.redraw();
}

</script>



</body></html>
